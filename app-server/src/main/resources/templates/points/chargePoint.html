<!Doctype html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>포인트 충전 및 입찰</title>
  <!-- 아임포트 라이브러리 추가 -->
  <script type="text/javascript" src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
  <script type="text/javascript" src="https://cdn.iamport.kr/js/iamport.payment-1.2.0.js"></script>
</head>

<body>
<div class="header" data-th-replace="header :: header"></div>
<h2>마이페이지</h2>

<img data-th-unless="${session.loginUser.photo}" style='height:80px' src='/images/avatar.png'><br>
<a data-th-if="${session.loginUser.photo}"
   data-th-href="|https://kr.object.ncloudstorage.com/bitcamp-nc7-bucket-22/member/${session.loginUser.photo}|"><br>
  <img data-th-src="|http://itceodfhklmc19010708.cdn.ntruss.com/member/${session.loginUser.photo}?type=f&w=60&h=80&faceopt=true&ttype=jpg|'"><br>
</a>

<span id="userId" data-th-text="'회원번호 : ' + ${session.loginUser.no}"></span><br>
<span id="userName" data-th-text="'회원 : ' + ${session.loginUser.name}+님"></span><br>
<span id="email" data-th-text="'이메일 : ' + ${session.loginUser.email}"></span><br>
<span id="point" data-th-text="'포인트 : ' + ${session.loginUser.points}"></span><br>


<!-- 포인트 충전 입력 필드 -->
<h2>포인트 충전</h2>
<input type="text" id="rechargeAmount" placeholder="충전할 포인트 입력" onkeyup="formatCurrency(this)">
<button id="rechargeButton">포인트 충전</button>

<!-- 입찰 금액 입력 필드 -->
<h2>입찰</h2>
<input type="text" id="bidAmount" placeholder="입찰할 금액 입력" onkeyup="formatCurrency(this)">
<button id="bidButton">입찰</button>

<!-- 결과 표시를 위한 엘리먼트 -->
<div id="result"></div>

<!-- 세션에서 사용자 포인트를 HTML에 포함 -->
<span id="userPoints" data-th-text="'보유포인트 : ' + ${session.loginUser.points}+원"></span>


<!-- 포인트 충전 및 입찰 스크립트 -->
<script>
  var IMP = window.IMP;

  // 천 단위로 콤마(,) 추가 함수
  function formatCurrency(input) {
      // 숫자 형식으로 변환하여 콤마 추가
      var value = input.value.replace(/\D/g, '');
      input.value = numberWithCommas(value);
  }

  // 숫자에 콤마(,) 추가하는 함수
  function numberWithCommas(x) {
      return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
  }

  // "포인트 충전" 버튼 클릭 시 실행될 함수
  document.getElementById('rechargeButton').addEventListener('click', function () {
      var rechargeInput = document.getElementById('rechargeAmount');
      var rechargeAmount = parseInt(rechargeInput.value.replace(/\D/g, '')); // 입력된 충전 포인트를 숫자로 변환
      var userNo = [[${session.loginUser.no}]];
      if (isNaN(rechargeAmount) || rechargeAmount <= 0) {
          alert('올바른 포인트를 입력하세요.'); // 유효한 포인트를 입력하지 않은 경우 알림
          return;
      }

      // KG이니시스 창을 열어 포인트를 충전하고, 성공 또는 실패 여부를 처리합니다.
      IMP.init('imp15221536'); // KG이니시스 가맹점 식별코드를 설정

      IMP.request_pay({
          pg: 'html5_inicis', // PG사 설정 (KG이니시스)
          pay_method: 'card', // 결제 방식 (신용카드)
          merchant_uid: 'recharge_' + new Date().getTime(), // 충전 고유 번호 생성
          name: '비트갤러리_포인트충전',
          amount: rechargeAmount, // 충전 금액 설정
          stats: '충전', // 변경: stats 추가
          buyer_email: '', // 구매자 이메일
      }, function (rsp) {
          if (rsp.success) {
              alert('포인트 충전이 완료되었습니다.');
              console.log(rsp); // 충전 정보 확인

              // AJAX 요청을 서버로 보냄
              $.ajax({
                  url: '/chargepoint', // 포인트 업데이트 API 엔드포인트 URL
                  method: 'POST',
                  data: {
                      userNo: userNo, // 사용자 번호
                      bidAmount: rechargeAmount, // 충전 금액
                  },
                  success: function (data) {
                      console.log(data);
                      try {
                          var resultData = JSON.parse(JSON.stringify(data));
                          alert('포인트 업데이트 결과:\n사용자 번호: ' + resultData.userNo + '\n충전 포인트: ' + resultData.bidAmount);
                          location.reload();
                      } catch (e) {
                          console.error('JSON 파싱 오류:', e);
                      }
                  },
                  error: function (error) {
                      console.error('포인트 업데이트 실패', error);
                  }
              });
          } else {
              alert('포인트 충전에 실패하였습니다.');
              console.log(rsp); // 충전 실패 정보 확인
          }
      });
  });


</script>

<script>
  // "입찰" 버튼 클릭 시 실행될 함수
  document.getElementById('bidButton').addEventListener('click', function () {
      var bidInput = document.getElementById('bidAmount');
      var bidAmount = parseInt(bidInput.value.replace(/\D/g, '')); // 입력된 입찰 금액을 숫자로 변환
      var userPoints = parseInt(document.getElementById('userPoints').textContent.replace(/\D/g, '')); // 보유 포인트를 가져옴
      var userNo = [[${session.loginUser.no}]];
      // JavaScript 코드


      if (isNaN(bidAmount) || bidAmount <= 0) {
          alert('올바른 입찰 금액을 입력하세요.'); // 유효한 금액을 입력하지 않은 경우 알림
          return;
      }

      if (userPoints < bidAmount) {
          alert('보유 포인트가 부족합니다'); // 보유 포인트가 입찰 금액보다 작은 경우 알림
          return;
      }

      // AJAX 요청을 서버로 보냄
      $.ajax({
          url: '/updatepoint', // 포인트 업데이트 API 엔드포인트 URL
          method: 'POST',
          data: {
              userNo: userNo, // 사용자 번호
              bidAmount: bidAmount, // 입찰 금액
          },

          success: function (data) {
              console.log(data);
              try {
                  var resultData = JSON.parse(JSON.stringify(data));
                  alert('포인트 업데이트 결과:\n사용자 번호: ' + resultData.userNo + '\n입찰 포인트: ' + resultData.bidAmount);
                  location.reload();
              } catch (e) {
                  console.error('JSON 파싱 오류:', e);
              }
          },
          error: function (error) {
              console.error('포인트 업데이트 실패', error);
          }
      });

      // 입찰 로직을 여기에 추가
      // 사용자의 입찰을 처리하고, 결과를 표시하거나 저장할 수 있습니다.
  });
// }

</script>
<div class="footer" data-th-replace="footer :: footer"></div>
</body>
</html>
