<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>포인트 충전 및 입찰</title>



    <!-- 아임포트 라이브러리 추가 -->
    <script type="text/javascript" src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
    <script type="text/javascript" src="https://cdn.iamport.kr/js/iamport.payment-1.2.0.js"></script>

    <link href="//maxcdn.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js"></script>

    <!-- Stylesheet -->
    <link rel="stylesheet" type="text/css" th:href="@{/css/mypage.css}">
    <link rel="stylesheet" type="text/css" th:href="@{/css/history.css}">
    <script th:src="@{/js/mypage.js}"></script>


    <!-- 아래의 코드를 추가 -->
    <script>
        // 냐옹 버튼 클릭 시 푸터를 보이게/숨기게 하는 함수
        function togglePointDiv() {
            var pointDiv = document.getElementById('pointDiv');
            var footer = document.getElementById('footer');

            if (pointDiv.style.display === 'none') {
                pointDiv.style.display = 'flex';
                footer.style.display = 'block'; // 푸터를 보이게 함
            } else {
                pointDiv.style.display = 'none';
                footer.style.display = 'none'; // 푸터를 숨김
            }
        }
    </script>


    <style>
        #footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: #f5f5f5;
            padding: 10px;
            text-align: center;
        }
        a {
        color: #000;
        text-decoration: none;
        text-shadow: 2px 2px 4px rgba(135, 206, 235, 0.5);
        }
    </style>



</head>
<body>
<div data-th-replace="header :: header"></div>
<!-- 사용자 정보 패널 -->
<div class="card card-container">
    <!-- <img class="profile-img-card" src="//lh3.googleusercontent.com/-6V8xOA6M7BA/AAAAAAAAAAI/AAAAAAAAAAA/rzlHcD0KYwo/photo.jpg?sz=120" alt="" /> -->
    <img id="profile-img" class="profile-img-card" src="//ssl.gstatic.com/accounts/ui/avatar_2x.png" />
    <p id="profile-name" class="profile-name-card">
        <span id="userName" data-th-text="${session.loginUser.name}+님 + ', 안녕하세요.'"></span><br>
    </p>

    <br>
    <span id="userId" data-th-text="'회원번호 : ' + ${session.loginUser.no}" style="display: block; text-align: center;"></span>
    <span id="email" data-th-text="'이메일 : ' + ${session.loginUser.email}" style="display: block; text-align: center;"></span>
    <span id="phone" data-th-text="'핸드폰번호 : ' + ${session.loginUser.phone}" style="display: block; text-align: center;"></span><br>


        <!-- 포인트 충전 입력 필드 -->
    <div style="display: flex; align-items: center;">
        <input type="text" id="rechargeAmount" style="text-align: center; font-size: 12px; width: 50%; margin-left:50px;" placeholder="충전할 포인트 입력" onkeyup="formatCurrency(this)">
        <button id="rechargeButton" style="font-size: 12px;">충전</button>
    </div>




        <!-- 결과 표시를 위한 엘리먼트 -->
        <div id="result"></div>

        <!-- 세션에서 사용자 포인트를 HTML에 포함 -->
        <span id="userPoints" style="text-align: center; font-size: 11px;" data-th-text="'보유포인트 : ' + ${session.loginUser.point}+원"></span>


</div><!-- /card-container -->

<button onclick="togglePointDiv()">냐옹</button>


<div id="pointDiv" style="display: none; flex-direction: column; align-items: center; justify-content: center; height: 50vh;">
    <section id="tabs" class="project-tab">
        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <nav>
                        <div class="nav nav-tabs nav-fill" id="nav-tab" role="tablist">
                            <a class="nav-item nav-link active" id="nav-home-tab" data-toggle="tab" href="#nav-home" role="tab" aria-controls="nav-home" aria-selected="true">환전 내역</a>
                            <a class="nav-item nav-link" id="nav-profile-tab" data-toggle="tab" href="#nav-profile" role="tab" aria-controls="nav-profile" aria-selected="false">입찰 내역</a>
                        </div>
                    </nav>
                        <div class="tab-content" style="width: 150%; margin: 0 auto; text-align: center;" id="nav-tabContent">
                        <div class="tab-pane fade show active" id="nav-home" role="tabpanel" aria-labelledby="nav-home-tab">
                            <table class="table" cellspacing="0">
                                <thead>
                                <tr>
                                    <th>번호</th>
                                    <th>제목</th>
                                    <th>작성일</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr>
                                    <td><a href="#">Work 1</a></td>
                                    <td>Doe</td>
                                    <td>john@example.com</td>
                                </tr>
                                <tr>
                                    <td><a href="#">Work 2</a></td>
                                    <td>Moe</td>
                                    <td>mary@example.com</td>
                                </tr>
                                <tr>
                                    <td><a href="#">Work 3</a></td>
                                    <td>Dooley</td>
                                    <td>july@example.com</td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="tab-pane fade" id="nav-profile" role="tabpanel" aria-labelledby="nav-profile-tab">
                            <table class="table" cellspacing="0">
                                <thead>
                                <tr>
                                    <th>Project Name</th>
                                    <th>Employer</th>
                                    <th>Time</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr>
                                    <td><a href="#">Work 1</a></td>
                                    <td>Doe</td>
                                    <td>john@example.com</td>
                                </tr>
                                <tr>
                                    <td><a href="#">Work 2</a></td>
                                    <td>Moe</td>
                                    <td>mary@example.com</td>
                                </tr>
                                <tr>
                                    <td><a href="#">Work 3</a></td>
                                    <td>Dooley</td>
                                    <td>july@example.com</td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="tab-pane fade" id="nav-contact" role="tabpanel" aria-labelledby="nav-contact-tab">
                            <table class="table" cellspacing="0">
                                <thead>
                                <tr>
                                    <th>Contest Name</th>
                                    <th>Date</th>
                                    <th>Award Position</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr>
                                    <td><a href="#">Work 1</a></td>
                                    <td>Doe</td>
                                    <td>john@example.com</td>
                                </tr>
                                <tr>
                                    <td><a href="#">Work 2</a></td>
                                    <td>Moe</td>
                                    <td>mary@example.com</td>
                                </tr>
                                <tr>
                                    <td><a href="#">Work 3</a></td>
                                    <td>Dooley</td>
                                    <td>july@example.com</td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    </div>
                </div>
            </div>
    </section>
</div>

<!-- 포인트 충전 및 입찰 스크립트 -->
<script>
    var IMP = window.IMP;

    // 천 단위로 콤마(,) 추가 함수
    function formatCurrency(input) {
        // 숫자 형식으로 변환하여 콤마 추가
        var value = input.value.replace(/\D/g, '');
        input.value = numberWithCommas(value);
    }

    // 숫자에 콤마(,) 추가하는 함수
    function numberWithCommas(x) {
        return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    }

    // "포인트 충전" 버튼 클릭 시 실행될 함수
    document.getElementById('rechargeButton').addEventListener('click', function () {
        var rechargeInput = document.getElementById('rechargeAmount');
        var rechargeAmount = parseInt(rechargeInput.value.replace(/\D/g, '')); // 입력된 충전 포인트를 숫자로 변환
        var userNo = [[${session.loginUser.no}]];
        if (isNaN(rechargeAmount) || rechargeAmount <= 0) {
            alert('올바른 포인트를 입력하세요.'); // 유효한 포인트를 입력하지 않은 경우 알림
            return;
        }

        // KG이니시스 창을 열어 포인트를 충전하고, 성공 또는 실패 여부를 처리합니다.
        IMP.init('imp15221536'); // KG이니시스 가맹점 식별코드를 설정

        IMP.request_pay({
            pg: 'html5_inicis', // PG사 설정 (KG이니시스)
            pay_method: 'card', // 결제 방식 (신용카드)
            merchant_uid: 'recharge_' + new Date().getTime(), // 충전 고유 번호 생성
            name: '비트갤러리_포인트충전',
            amount: rechargeAmount, // 충전 금액 설정
            stats: '충전', // 변경: stats 추가
            buyer_email: '', // 구매자 이메일
        }, function (rsp) {
            if (rsp.success) {
                alert('포인트 충전이 완료되었습니다.');
                console.log(rsp); // 충전 정보 확인

                // AJAX 요청을 서버로 보냄
                $.ajax({
                    url: '/chargepoint', // 포인트 업데이트 API 엔드포인트 URL
                    method: 'POST',
                    data: {
                        userNo: userNo, // 사용자 번호
                        bidAmount: rechargeAmount, // 충전 금액
                    },
                    success: function (data) {
                        console.log(data);
                        try {
                            var resultData = JSON.parse(JSON.stringify(data));
                            alert('포인트 업데이트 결과:\n사용자 번호: ' + resultData.userNo + '\n충전 포인트: ' + resultData.bidAmount);
                            location.reload();
                        } catch (e) {
                            console.error('JSON 파싱 오류:', e);
                        }
                    },
                    error: function (error) {
                        console.error('포인트 업데이트 실패', error);
                    }
                });
            } else {
                alert('포인트 충전에 실패하였습니다.');
                console.log(rsp); // 충전 실패 정보 확인
            }
        });
    });


</script>

<script>
    // "입찰" 버튼 클릭 시 실행될 함수
    document.getElementById('bidButton').addEventListener('click', function () {
        var bidInput = document.getElementById('bidAmount');
        var bidAmount = parseInt(bidInput.value.replace(/\D/g, '')); // 입력된 입찰 금액을 숫자로 변환
        var userPoints = parseInt(document.getElementById('userPoints').textContent.replace(/\D/g, '')); // 보유 포인트를 가져옴
        var userNo = [[${session.loginUser.no}]];
        // JavaScript 코드


        if (isNaN(bidAmount) || bidAmount <= 0) {
            alert('올바른 입찰 금액을 입력하세요.'); // 유효한 금액을 입력하지 않은 경우 알림
            return;
        }

        if (userPoints < bidAmount) {
            alert('보유 포인트가 부족합니다'); // 보유 포인트가 입찰 금액보다 작은 경우 알림
            return;
        }

        // AJAX 요청을 서버로 보냄
        $.ajax({
            url: '/updatepoint', // 포인트 업데이트 API 엔드포인트 URL
            method: 'POST',
            data: {
                userNo: userNo, // 사용자 번호
                bidAmount: bidAmount, // 입찰 금액
            },

            success: function (data) {
                console.log(data);
                try {
                    var resultData = JSON.parse(JSON.stringify(data));
                    alert('포인트 업데이트 결과:\n사용자 번호: ' + resultData.userNo + '\n입찰 포인트: ' + resultData.bidAmount);
                    location.reload();
                } catch (e) {
                    console.error('JSON 파싱 오류:', e);
                }
            },
            error: function (error) {
                console.error('포인트 업데이트 실패', error);
            }
        });

        // 입찰 로직을 여기에 추가
        // 사용자의 입찰을 처리하고, 결과를 표시하거나 저장할 수 있습니다.
    });
    // }

</script>

</body>

</html>
